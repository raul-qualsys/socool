<?php
 use Tygh\Registry; use Tygh\Addons\SchemesManager; use Tygh\Http; if (!defined('BOOTSTRAP')) { die('Access denied'); } function sd_MGYyMmU0ZGIxMzk2ODUxNGI0ZTUwNTQx($request) { $company_id = null; if (isset($request['company_id'])) { $company_id = $request['company_id']; } elseif (isset($request['product_id'])) { $company_id = db_get_field( 'SELECT company_id FROM ?:products WHERE product_id = ?i', $request['product_id'] ); } return $company_id; } function sd_ZTIyZDA0YjhlNGIwZjU0ZDllMjcwNjE2($license = '') { if (!fn_allowed_for('MULTIVENDOR')) { $companies = db_get_array('SELECT storefront, secure_storefront FROM ?:companies'); } else { $companies = array(array('storefront' => fn_url('', 'C', 'http'))); } $addon = 'sd_facebook_pixel'; $request = array( 'companies' => $companies, 'host' => Registry::get('config.current_host'), 'lang_code' => CART_LANGUAGE, 'addon' => $addon, 'addon_version' => fn_get_addon_version($addon), 'license' => !empty($license) ? trim($license) : Registry::get("addons.{$addon}.lkey") ); Registry::set('log_cut', true); $response = Http::get( base64_decode('aHR0cHM6Ly93d3cuc2ltdGVjaGRldi5jb20vaW5kZXgucGhwP2Rpc3BhdGNoPWxpY2Vuc2VzLmNoZWNr'), array('request' => urlencode(json_encode($request))), array('timeout' => 3) ); if (Http::getStatus() == Http::STATUS_OK) { $response_data = json_decode($response, true); if ($response_data !== null) { $status = isset($response_data['status']) ? $response_data['status'] : 'F'; if (isset($response_data['notice'])) { fn_set_notification( isset($response_data['type']) ? $response_data['type'] : 'W', SchemesManager::getName($addon, CART_LANGUAGE), $response_data['notice'], isset($response_data['state']) ? $response_data['state'] : '' ); } } else { $status = $response; } if ($status != 'A') { fn_update_addon_status($addon, 'D', false); } } else { $status = 'A'; } return $status == 'A'; } function fn_settings_actions_addons_sd_facebook_pixel_lkey(&$new_value, $old_value) { if (sd_ZTIyZDA0YjhlNGIwZjU0ZDllMjcwNjE2($new_value)) { $new_value = trim($new_value); } } function fn_settings_actions_addons_sd_facebook_pixel(&$new_status, $old_status) { if ($new_status == 'A' && !sd_ZTIyZDA0YjhlNGIwZjU0ZDllMjcwNjE2()) { $new_status = 'D'; } } function fn_sd_facebook_pixel_set_admin_notification($user_data) { if (AREA == 'A' && $user_data['is_root'] == 'Y') { sd_ZTIyZDA0YjhlNGIwZjU0ZDllMjcwNjE2(); } } function sd_MDFjMjlhYzk2MzIxOWI2Y2M1NjA0Yjhh($company_ids) { $facebook_pixel_ids = array(); if ($company_ids) { $facebook_pixel_ids = db_get_hash_single_array( 'SELECT identifier_facebook_pixel, company_id FROM ?:companies' . ' WHERE company_id IN (?n) AND identifier_facebook_pixel IS NOT NULL', array('company_id', 'identifier_facebook_pixel'), $company_ids ); } return $facebook_pixel_ids; } function sd_MjI3NTYyNTBjYTI1ODlmYWUwZDNmZGY4($order_id) { $facebook_pixel_ids = array(); if ($order_id) { $facebook_pixel_ids = db_get_hash_single_array( 'SELECT distinct c.identifier_facebook_pixel, c.company_id' . ' FROM ?:order_details o INNER JOIN ?:products p on p.product_id = o.product_id' . ' INNER JOIN ?:companies c on c.company_id = p.company_id' . ' WHERE o.order_id = ?i AND c.identifier_facebook_pixel IS NOT NULL', array('company_id', 'identifier_facebook_pixel'), $order_id ); } return $facebook_pixel_ids; } function sd_MDQ4NTA4ZjA3YTMyZjkxZjRlOWNhMGNi($order) { $root_content = array( 'num_items' => 0, 'contents' => array(), 'value' => 0 ); $contents = array(); foreach ($order['product_groups'] as $group) { $num_items = 0; $sum = 0; $products = array(); foreach ($group['products'] as $product) { $num_items = $num_items + $product['amount']; $sum = $sum + ($product['amount'] * $product['price']); $products[] = array( 'id' => $product['product_id'], 'quantity' => $product['amount'], 'item_price' => $product['price'], ); } $company_id = $group['company_id']; $contents[$company_id] = array( 'num_items' => $num_items, 'contents' => $products, 'value' => $sum ); $root_content = array( 'num_items' => $root_content['num_items'] + $num_items, 'contents' => array_merge($root_content['contents'], $products), 'value' => $root_content['value'] + $sum ); } if (isset($order['secondary_currency'])) { $root_content['currency'] = $order['secondary_currency']; } $contents[0] = $root_content; return $contents; } function sd_NzlmMTJmMzBjYzdlOGI4MWUxMDI4ZWQx($product, $auth, $lang_code = CART_LANGUAGE) { $product_object = array(); if (!empty($product['product_id'])) { $product['product_id'] = strval($product['product_id']); $settings = Registry::get('addons.sd_seo_jsonld'); $product_format_data = sd_YzNiNDAzN2Q4YWUzMmRjYzAwMWQzYmVi($product, $lang_code); $product_object = array( 'title' => $product_format_data['title'], 'url' => fn_url('products.view?product_id=' . $product['product_id']), 'image' => !empty($product['main_pair']['detailed']['image_path']) ? $product['main_pair']['detailed']['image_path'] : '', 'image_width' => !empty($product['main_pair']['detailed']['image_x']) ? $product['main_pair']['detailed']['image_x'] : '', 'image_height' => !empty($product['main_pair']['detailed']['image_y']) ? $product['main_pair']['detailed']['image_y'] : '', 'site_name' => !empty($site_name) ? $site_name : Registry::get('settings.Company.company_name'), 'type' => 'product', 'id' => $product['product_id'], 'brand' => $product_format_data['brand'], 'availability' => $product_format_data['availability'], 'price' => $product_format_data['price'], 'currency' => $product_format_data['currency'], 'condition' => 'new' ); } return $product_object; } function sd_YzNiNDAzN2Q4YWUzMmRjYzAwMWQzYmVi($product, $lang_code = CART_LANGUAGE) { $amount = 0; if (!empty($product['inventory_amount'])) { $amount = $product['inventory_amount']; } elseif (!empty($product['amount'])) { $amount = $product['amount']; } if (!empty($product['min_qty']) && $amount < $product['min_qty']) { $amount = 0; } if ($amount > 0 || Registry::get('settings.General.inventory_tracking') == 'N') { $availability = 'in stock'; } else { $availability = 'out of stock'; } $settings = Registry::get('addons.sd_facebook_pixel'); $brand = ''; if (!empty($settings['brand_feature'])) { $brand_id = $settings['brand_feature']; if (!empty($product['header_features'][$brand_id]['variant'])) { $brand = $product['header_features'][$brand_id]['variant']; } else { list($features) = fn_get_product_features(array( 'product_id' => $product['product_id'], 'feature_id' => $settings['brand_feature'], 'variants' => true, ), 0, $lang_code); if (!empty($features[$settings['brand_feature']]['variant_id'])) { $brand = $features[$brand_id]['variants'][$features[$brand_id]['variant_id']]['variant']; } } } if (fn_allowed_for('MULTIVENDOR') && empty($settings['brand_feature'])) { $brand = !empty($product['company_name']) ? $product['company_name'] : ''; } $currency = fn_get_secondary_currency(); $price = !empty($product['price']) ? $product['price'] : 0; if (!empty($product['taxed_price'])) { $price = $product['taxed_price']; } if (!empty($price)) { $format_price = fn_format_price($price); $price = fn_format_price_by_currency($format_price, CART_PRIMARY_CURRENCY, $currency); } $product_name = isset($product['product']) ? $product['product'] : fn_get_product_name($product['product_id']); return array( 'title' => $product_name, 'brand' => $brand, 'availability' => $availability, 'price' => $price, 'currency' => $currency ); } 